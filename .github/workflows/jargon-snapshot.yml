name: jargon_onRelease

on:
  workflow_call:
    inputs:
      vocabulary_name:
        description: 'Vocabulary name'
        type: string
        required: true
jobs:

  merge:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - run: 'echo "vocabulary_name: ${{ inputs.vocabulary_name }}"'

      - id: download-agriculture-vocabulary
        if: ${{ inputs.vocabulary_name != 'agriculture' }}
        uses: robinraju/release-downloader@v1.8
        with:
          repository: "uncefact/vocab-agriculture"
          latest: true
          fileName: "agriculture.jsonld"
          out-file-path: "vocab"
          tarBall: false
          zipBall: false
          extract: false
      - id: download-compliance-vocabulary
        if: ${{ inputs.vocabulary_name != 'compliance' }}
        uses: robinraju/release-downloader@v1.8
        with:
          repository: "uncefact/vocab-compliance"
          latest: true
          fileName: "compliance.jsonld"
          out-file-path: "vocab"
          tarBall: false
          zipBall: false
          extract: false
      - id: download-finance-vocabulary
        if: ${{ inputs.vocabulary_name != 'finance' }}
        uses: robinraju/release-downloader@v1.8
        with:
          repository: "uncefact/vocab-finance"
          latest: true
          fileName: "finance.jsonld"
          out-file-path: "vocab"
          tarBall: false
          zipBall: false
          extract: false
      - id: download-core-vocabulary
        if: ${{ inputs.vocabulary_name != 'core' }}
        uses: robinraju/release-downloader@v1.8
        with:
          repository: "uncefact/vocab-core"
          latest: true
          fileName: "core.jsonld"
          out-file-path: "vocab"
          tarBall: false
          zipBall: false
          extract: false
      - id: download-tourism-vocabulary
        if: ${{ inputs.vocabulary_name != 'tourism' }}
        uses: robinraju/release-downloader@v1.8
        with:
          repository: "uncefact/vocab-tourism"
          latest: true
          fileName: "tourism.jsonld"
          out-file-path: "vocab"
          tarBall: false
          zipBall: false
          extract: false
      - id: download-transport-vocabulary
        if: ${{ inputs.vocabulary_name != 'transport' }}
        uses: robinraju/release-downloader@v1.8
        with:
          repository: "uncefact/vocab-transport"
          latest: true
          fileName: "transport.jsonld"
          out-file-path: "vocab"
          tarBall: false
          zipBall: false
          extract: false
      - id: download-trade-vocabulary
        if: ${{ inputs.vocabulary_name != 'trade' }}
        uses: robinraju/release-downloader@v1.8
        with:
          repository: "uncefact/vocab-trade"
          latest: true
          fileName: "trade.jsonld"
          out-file-path: "vocab"
          tarBall: false
          zipBall: false
          extract: false
      - id: download-merge-utility
        uses: robinraju/release-downloader@v1.8
        with:
          repository: "uncefact/utilities"
          latest: true
          fileName: "vocab-jsonld-merge-1.0.2.jar"
          tarBall: false
          zipBall: false
          extract: false
      - uses: actions/setup-java@v3
        with:
          distribution: 'adopt'
          java-version: '11'
      - run: 'echo "field: ${{ github.event.client_payload.artefacts.jsonldVocab.url }}"'
      - run: 'echo "field: ${{ github.event.client_payload.artefacts.jsonldVocab.fileName }}"'
      - run: 'wget -O ${{ inputs.vocabulary_name }}.jsonld ${{ github.event.client_payload.artefacts.jsonldVocab.url }}'
      - run: 'mv ${{ inputs.vocabulary_name }}.jsonld vocab/'
      - run: java -jar vocab-jsonld-merge-1.0.2.jar
      - run: 'mv merged.jsonld vocab/'
      - run: |
          rm vocab-jsonld-merge-1.0.2.jar
          cd vocab && rm -- !(merged.jsonld|transport.jsonld)
      - name: snapshot PR
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "chore: jargon snapshot preview"
          delete-branch: true
          title: 'chore: update vocabulary'
          body: |
            Updates vocabulary triggered by created snapshot in the Jargon domain.
          base: 'main'
          branch: create-pull-request/snapshot
          draft: true
  pages_preview:
    needs:
      - merge
    uses: uncefact/vocabulary-outputs/.github/workflows/update-jargon.yml@jargon-pages
    with:
      vocabulary_name: ${{ inputs.vocabulary_name }}
      branch_name: create-pull-request/snapshot
    secrets: inherit
